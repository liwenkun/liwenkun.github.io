<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="150x150" href="/images/favicon-150x150-next.png">
  <link rel="icon" type="image/png" sizes="150x150" href="/images/favicon-150x150-next.png">
  <link rel="icon" type="image/png" sizes="150x150" href="/images/favicon-150x150-next.png">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liwenkun.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"order":-2}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="前言Kotlin 中的协程是无栈协程，网上很多文章都说无栈协程一般都是通过状态机实现的，于是我打算利用反编译工具并结合协程库源码，来探究一下 Kotlin 到底是如何通过状态机实现协程的。 一个简单的示例1234567891011121314151617181920fun main() &#123;    runBlocking &#123;        val result &#x3D; fun1()">
<meta property="og:type" content="article">
<meta property="og:title" content="探究 Kotlin 协程中的状态机">
<meta property="og:url" content="https://liwenkun.github.io/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/index.html">
<meta property="og:site_name" content="Chance 的博客">
<meta property="og:description" content="前言Kotlin 中的协程是无栈协程，网上很多文章都说无栈协程一般都是通过状态机实现的，于是我打算利用反编译工具并结合协程库源码，来探究一下 Kotlin 到底是如何通过状态机实现协程的。 一个简单的示例1234567891011121314151617181920fun main() &#123;    runBlocking &#123;        val result &#x3D; fun1()">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liwenkun.github.io/img/in-post/post_kotlin_coroutine_state_machine/kotlin_coroutine.svg">
<meta property="article:published_time" content="2024-04-08T00:00:00.000Z">
<meta property="article:modified_time" content="2026-01-04T08:49:59.333Z">
<meta property="article:author" content="Chance">
<meta property="article:tag" content="Kotlin">
<meta property="article:tag" content="协程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liwenkun.github.io/img/in-post/post_kotlin_coroutine_state_machine/kotlin_coroutine.svg">

<link rel="canonical" href="https://liwenkun.github.io/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>探究 Kotlin 协程中的状态机 | Chance 的博客</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-76493784-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-76493784-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4cc1f2d8f3067386cc5cdb626a202900";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Chance 的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">吾生也有涯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">28</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">29</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liwenkun.github.io/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
      <meta itemprop="name" content="Chance">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chance 的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          探究 Kotlin 协程中的状态机
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-08 00:00:00" itemprop="dateCreated datePublished" datetime="2024-04-08T00:00:00+00:00">2024-04-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-04 08:49:59" itemprop="dateModified" datetime="2026-01-04T08:49:59+00:00">2026-01-04</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Kotlin 中的协程是无栈协程，网上很多文章都说无栈协程一般都是通过状态机实现的，于是我打算利用反编译工具并结合协程库源码，来探究一下 Kotlin 到底是如何通过状态机实现协程的。</p>
<h1 id="一个简单的示例"><a href="#一个简单的示例" class="headerlink" title="一个简单的示例"></a>一个简单的示例</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    runBlocking &#123;</span><br><span class="line">        <span class="keyword">val</span> result = fun1()</span><br><span class="line">        println(result)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> localInt = <span class="number">0</span></span><br><span class="line">    localInt += fun2()</span><br><span class="line">    localInt += fun3()</span><br><span class="line">    <span class="keyword">return</span> localInt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun2</span><span class="params">()</span></span>: <span class="built_in">Int</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fun3</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    delay(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>以上代码通过 <code>runBlocking()</code>​ 开启协程，协程调用 <code>fun1()</code>​ ，然后打印结果。<code>fun1()</code>​ 是一个 <code>suspend</code>​ 方法，它定义了一个局部变量 <code>localInt</code>​，然后依次执行了 <code>fun2()</code>​ 和 <code>fun3()</code>​ 并将二者结果累加到 <code>localInt</code>​ 中，最后将 <code>localInt</code>​ 返回。<code>fun2()</code>​ 是一个有 suspend 标识的同步方法, <code>fun3()</code>​ 内调用了 <code>delay()</code>​，<code>delay()</code>​ 是协程库提供的 <code>suspend</code>​方法。 </p>
<p>下面我们将会从 <code>runBlocking()</code>​ 开始，揭开 Kotlin 协程的神秘面纱。</p>
<h2 id="Builders-runBlocking"><a href="#Builders-runBlocking" class="headerlink" title="Builders#runBlocking"></a>Builders#runBlocking</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">runBlocking</span><span class="params">(context: <span class="type">CoroutineContext</span>, block: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.() -&gt; <span class="type">T</span>)</span></span>: T &#123;</span><br><span class="line">    contract &#123;</span><br><span class="line">        callsInPlace(block, InvocationKind.EXACTLY_ONCE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> currentThread = Thread.currentThread()</span><br><span class="line">    <span class="keyword">val</span> contextInterceptor = context[ContinuationInterceptor]</span><br><span class="line">    <span class="keyword">val</span> eventLoop: EventLoop?</span><br><span class="line">    <span class="keyword">val</span> newContext: CoroutineContext</span><br><span class="line">    <span class="keyword">if</span> (contextInterceptor == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// create or use private event loop if no dispatcher is specified</span></span><br><span class="line">        eventLoop = ThreadLocalEventLoop.eventLoop</span><br><span class="line">        newContext = GlobalScope.newCoroutineContext(context + eventLoop)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// See if context&#x27;s interceptor is an event loop that we shall use (to support TestContext)</span></span><br><span class="line">        <span class="comment">// or take an existing thread-local event loop if present to avoid blocking it (but don&#x27;t create one)</span></span><br><span class="line">        eventLoop = (contextInterceptor <span class="keyword">as</span>? EventLoop)?.takeIf &#123; it.shouldBeProcessedFromContext() &#125;</span><br><span class="line">            ?: ThreadLocalEventLoop.currentOrNull()</span><br><span class="line">        newContext = GlobalScope.newCoroutineContext(context)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> coroutine = BlockingCoroutine&lt;T&gt;(newContext, currentThread, eventLoop)</span><br><span class="line">    coroutine.start(CoroutineStart.DEFAULT, coroutine, block)</span><br><span class="line">    <span class="keyword">return</span> coroutine.joinBlocking()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的逻辑非常清晰：</p>
<ul>
<li>5 ~ 19 行用来构建协程的上下文，协程上下文是一些元素的集合，包括拦截器，代表协程的任务，异常处理器，协程名称等。</li>
<li>20 行 <code>BlockingCoroutine&lt;T&gt;(newContext, currentThread, eventLoop)</code>​构建协程对象</li>
<li>21 行 <code>coroutine#start()</code>​ 启动协程</li>
<li>22 行阻塞当前线程，直到协程结束。</li>
</ul>
<h2 id="Coroutine-Start"><a href="#Coroutine-Start" class="headerlink" title="Coroutine#Start"></a>Coroutine#Start</h2><p>省略一些中间过程，<code>Coroutine#Start</code>​ 最后会调用到下面这个方法：</p>
<h3 id="CoroutineStarter-invoke"><a href="#CoroutineStarter-invoke" class="headerlink" title="CoroutineStarter#invoke"></a>CoroutineStarter#invoke</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="title">invoke</span><span class="params">(block: <span class="type">suspend</span> <span class="type">R</span>.() -&gt; <span class="type">T</span>, receiver: <span class="type">R</span>, completion: <span class="type">Continuation</span>&lt;<span class="type">T</span>&gt;)</span></span>: <span class="built_in">Unit</span> =</span><br><span class="line">        <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            DEFAULT -&gt; block.startCoroutineCancellable(receiver, completion)</span><br><span class="line">            ATOMIC -&gt; block.startCoroutine(receiver, completion)</span><br><span class="line">            UNDISPATCHED -&gt; block.startCoroutineUndispatched(receiver, completion)</span><br><span class="line">            LAZY -&gt; <span class="built_in">Unit</span> <span class="comment">// will start lazily</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>协程有多种启动模式，简单起见，我们只研究 <code>DEFAULT</code>​ 模式，其他分支原理大同小异。<code>block.startCoroutineCancellable()</code>​ 源码如下：</p>
<h3 id="Cancellable-startCoroutineCancellable"><a href="#Cancellable-startCoroutineCancellable" class="headerlink" title="Cancellable#startCoroutineCancellable"></a>Cancellable#startCoroutineCancellable</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Use this function to start coroutine in a cancellable way, so that it can be cancelled</span></span><br><span class="line"><span class="comment"> * while waiting to be dispatched.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> (R)</span></span> -&gt; T).startCoroutineCancellable(</span><br><span class="line">    receiver: R, completion: Continuation&lt;T&gt;,</span><br><span class="line">    onCancellation: ((cause: Throwable) -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line">) =</span><br><span class="line">    runSafely(completion) &#123;</span><br><span class="line">        createCoroutineUnintercepted(receiver, completion).intercepted().resumeCancellableWith(Result.success(<span class="built_in">Unit</span>), onCancellation)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重点是 <code>createCoroutineUnintercepted()</code>​：</p>
<h3 id="IntrinsicsJvm-createCoroutineUnintercepted"><a href="#IntrinsicsJvm-createCoroutineUnintercepted" class="headerlink" title="IntrinsicsJvm#createCoroutineUnintercepted"></a>IntrinsicsJvm#createCoroutineUnintercepted</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SinceKotlin(<span class="string">&quot;1.3&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> R.()</span></span> -&gt; T).createCoroutineUnintercepted(</span><br><span class="line">    receiver: R,</span><br><span class="line">    completion: Continuation&lt;T&gt;</span><br><span class="line">): Continuation&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> probeCompletion = probeCoroutineCreated(completion)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> BaseContinuationImpl)</span><br><span class="line">        create(receiver, probeCompletion)</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        createCoroutineFromSuspendFunction(probeCompletion) &#123;</span><br><span class="line">            (<span class="keyword">this</span> <span class="keyword">as</span> Function2&lt;R, Continuation&lt;T&gt;, Any?&gt;).invoke(receiver, it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般来说代码会走到 if 分支。if 分支调用了 suspend lambda 的 <code>create()</code>​ 方法。这个方法是编译器为 suspend lambda 生成的。我们需要反编译代码来进一步探究。</p>
<p class="notice-info">传统的反编译工具没法反编译 Kotlin 代码，要使用 IDEA 自带的工具：打开 Kotlin 字节码文件，然后点击 工具 -> Kotlin -> 反编译为  Java。</p>

<h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><p>先看 <code>main</code>​ 方法的反编译结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">      BuildersKt.runBlocking$<span class="keyword">default</span>((CoroutineContext)<span class="literal">null</span>, (Function2)(<span class="keyword">new</span> <span class="title class_">Function2</span>((Continuation)<span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="type">int</span> label;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(<span class="meta">@NotNull</span> Object $result)</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> IntrinsicsKt.getCOROUTINE_SUSPENDED();</span><br><span class="line">            Object var10000;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">this</span>.label) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  <span class="type">Continuation</span> <span class="variable">var4</span> <span class="operator">=</span> (Continuation)<span class="built_in">this</span>;</span><br><span class="line">                  <span class="built_in">this</span>.label = <span class="number">1</span>;</span><br><span class="line">                  var10000 = TestKt.fun1(var4);          <span class="comment">// fun1()</span></span><br><span class="line">                  <span class="keyword">if</span> (var10000 == var3) &#123;</span><br><span class="line">                     <span class="keyword">return</span> var3;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  var10000 = $result;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ((Number)var10000).intValue();</span><br><span class="line">            System.out.println(result);</span><br><span class="line">            <span class="keyword">return</span> Unit.INSTANCE;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@NotNull</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Continuation <span class="title function_">create</span><span class="params">(<span class="meta">@Nullable</span> Object value, <span class="meta">@NotNull</span> Continuation $completion)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Continuation)(<span class="keyword">new</span> &lt;anonymous constructor&gt;($completion));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> CoroutineScope p1, <span class="meta">@Nullable</span> Continuation p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((&lt;undefinedtype&gt;)<span class="built_in">this</span>.create(p1, p2)).invokeSuspend(Unit.INSTANCE);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object p1, Object p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.invoke((CoroutineScope)p1, (Continuation)p2);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;), <span class="number">1</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>​<code>runBlocking$default()</code>​ 是 <code>runBlocking()</code>​ 的反编译后的名字。它接收四个参数，后面两个参数暂时不用理会。第一个参数类型为 <code>CoroutineContext</code>​，传入的是 <code>null</code>​。第二个参数是一个 <code>Function2</code>​ 对象，<code>Function2</code>​ 是 Kotlin 库中的一个接口，定义如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Function2</span>&lt;<span class="type">in P1, in P2, out R</span>&gt; : <span class="type">Function</span>&lt;<span class="type">R</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(p1: <span class="type">P1</span>, p2: <span class="type">P2</span>)</span></span>: R</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Kotlin 编译器用 <code>Function1</code>​，<code>Function2</code>​ … <code>FuncitonX</code>​  接口来实现 lambda 表达式，Function 后面的数字表示 lambda 参数的数量。如果 lambda 有 receiver，receiver 会被视为其第一个参数，则 <code>invoke()</code>​ 的第一个参数为 receiver，后续参数为 lambda 的实际参数。例如，一个带有 receiver 的 lambda 表达式  <code>val a: Int.(Int, Int) -&gt; Int = &#123; x: Int, y: Int -&gt; this + x + y &#125;</code>​ 会用类似下面的代码来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Function3</span> <span class="variable">a</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Function3</span>&lt;Integer, Integer, Integer, Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Integer <span class="title function_">invoke</span><span class="params">(Integer p1, Integer p2, Integer p3)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> p1 + p2 + p3;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 suspend lambda，实现则略有不同，例如对于一个有 receiver 的 suspend lambda： <code>val a: suspend Int.() -&gt; Unit = &#123;&#125;</code>​，实际上生成的对象通常长这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_">SuspendLambda</span> <span class="keyword">implements</span> <span class="title class_">Function2</span>&lt;Object, Object, Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(Object result)</span> &#123;</span><br><span class="line">		 <span class="comment">/* lambda 函数体逻辑，省略 */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">_SuspendLambda</span><span class="params">(Continuation completion)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(<span class="number">0</span> <span class="comment">/* 这个值具体是多少不知道，也不重要，我这里是乱写的 */</span>, completion):</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> Continuation <span class="title function_">create</span><span class="params">(Object value, Continuation $completion)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (Continuation)(<span class="keyword">new</span> &lt;anonymous constructor&gt;($completion));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 类型具体化后的 invoke</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(<span class="type">int</span> receiver, Continuation completion)</span> &#123;</span><br><span class="line">      <span class="comment">// 为什么不直接调用 invokeSuspend，而是重新生成一个实例？</span></span><br><span class="line">      <span class="keyword">return</span> ((&lt;undefinedtype&gt;)<span class="built_in">this</span>.create(receiver, completion)).invokeSuspend(Unit.INSTANCE);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// Function2 接口方法 invoke</span></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object receiver, Object completion)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.invoke(((Number)p1).intValue(), (Continuation)p2);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Function2&lt;Object, Object, Object&gt; a = <span class="keyword">new</span> <span class="title class_">A</span>&lt;&gt;(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>和普通 lambda 不一样的地方在于，kotlin 为 suspend lambda 生成的类除了实现了 <code>FunctionX 接口</code>，还继承了 <code>SuspendLambda</code>，其实现的 invoke() 方法多了一个额外的 <code>Cotinuation</code>​ 类型的参数。此外，编译器还实现了继承自 <code>SuspendLambda</code> 的抽象方法 <code>invokeSuspend()</code>​ 、<code>create()</code>​ ， 并生成了一个 <code>invoke()</code>​ 重载方法。<code>invokeSuspend()</code>​ 中包含的是 lambda 函数体的逻辑，<code>create()</code>​ 则是用来创建该类的一个新实例，<code>invoke()</code>​ 重载方法貌似有点多余，只是对参数类型具体化了一下而已。</p>
<p class="notice-success">为什么 invoke() 方法不直接调用 invokeSuspend()，而是要多此一举重新生成一个实例再去调用？因为 suspend lambda 实际上被编译成了一个状态机，一个状态机实例维护的是一次 suspend lambda 执行期间的状态，虽然很多时候我们创建的 lambda 实例都是匿名的，用完即弃（比如我们给 runBlocking() 传入的 suspend lambda），但一个实例也可以多次调用（比如多次调用 a()），为了避免同一个实例多次调用导致状态机内部状态混乱，Kotlin 会在每次调用时生成一个全新的实例。a 虽然本身是一个 suspend lambda 实例，但它在这里的角色更像是一个 suspend lambda 的实例工厂。</p>

<p>现在回过头来看 <code>runBlocking</code>​ 的 suspned lambda 参数反编译后的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Function2</span>((Continuation)<span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="type">int</span> label;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(<span class="meta">@NotNull</span> Object $result)</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">var3</span> <span class="operator">=</span> IntrinsicsKt.getCOROUTINE_SUSPENDED();</span><br><span class="line">            Object var10000;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">this</span>.label) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  <span class="type">Continuation</span> <span class="variable">var4</span> <span class="operator">=</span> (Continuation)<span class="built_in">this</span>;</span><br><span class="line">                  <span class="built_in">this</span>.label = <span class="number">1</span>;</span><br><span class="line">                  var10000 = TestKt.fun1(var4);          <span class="comment">// fun1()</span></span><br><span class="line">                  <span class="keyword">if</span> (var10000 == var3) &#123;</span><br><span class="line">                     <span class="keyword">return</span> var3;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                  ResultKt.throwOnFailure($result);</span><br><span class="line">                  var10000 = $result;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> ((Number)var10000).intValue();</span><br><span class="line">            System.out.println(result);</span><br><span class="line">            <span class="keyword">return</span> Unit.INSTANCE;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@NotNull</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Continuation <span class="title function_">create</span><span class="params">(<span class="meta">@Nullable</span> Object value, <span class="meta">@NotNull</span> Continuation $completion)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Continuation)(<span class="keyword">new</span> &lt;anonymous constructor&gt;($completion));</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> CoroutineScope p1, <span class="meta">@Nullable</span> Continuation p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((&lt;undefinedtype&gt;)<span class="built_in">this</span>.create(p1, p2)).invokeSuspend(Unit.INSTANCE);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// $FF: synthetic method</span></span><br><span class="line">         <span class="comment">// $FF: bridge method</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object p1, Object p2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.invoke((CoroutineScope)p1, (Continuation)p2);</span><br><span class="line">         &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>它就是编译器为我们生成的 <code>SuspendLambda</code> 匿名子类对象，后续我会用 <code>_SuspendLambda</code>​ 代指这个匿名子类。</p>
<p class="notice-info">反编译器没能展示出这个匿名类和 SuspendLambda 的继承关系，通过在 runBlocking() 中添加断点可以得知 suspend lambda 最终确实被编译成了 SuspendLambda 的一个匿名子类。</p>

<p><code>_SuspendLambda</code> 的 <code>invoke()</code>​ 有两个参数，第一个参数类型为 <code>CoroutineScope</code>​，它是 suspend lambda 的 receiver。</p>
<p>回过头看看 <code>createCoroutineUnintercepted</code>​：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SinceKotlin(&quot;1.3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> actual fun &lt;R, T&gt; (suspend R.() -&gt; T).createCoroutineUnintercepted(</span><br><span class="line">    receiver: R,</span><br><span class="line">    completion: Continuation&lt;T&gt;</span><br><span class="line">): Continuation&lt;Unit&gt; &#123;</span><br><span class="line">    <span class="type">val</span> <span class="variable">probeCompletion</span> <span class="operator">=</span> probeCoroutineCreated(completion)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (<span class="built_in">this</span> is BaseContinuationImpl)</span><br><span class="line">        create(receiver, probeCompletion)</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        createCoroutineFromSuspendFunction(probeCompletion) &#123;</span><br><span class="line">            (<span class="built_in">this</span> as Function2&lt;R, Continuation&lt;T&gt;, Any?&gt;).invoke(receiver, it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>this</code>​ 是 suspend lambda，前面说了，它是一个 <code>_SuspendLambda</code>​ 对象，<code>_SuspendLambda</code>​ 的继承链是：<code>_SuspendLambda</code>​ -&gt; <code>SuspendLambda</code> -&gt; <code>ContinuationImpl</code>​ -&gt; <code>BaseContinuationImpl</code>​ -&gt; <code>Continuation</code>​，因此代码会进到 <code>if</code>​ 分支，调用 <code>_SuspendLambda</code> 的 <code>create()</code>​ 方法返回该它的一个新实例。</p>
<p class="notice-info">什么时候会走到 else 分支目前我并不清楚，因为目前为止我发现 suspend lambda 都是继承自 BaseContinuationImpl，这不是重点，我们先不管。​</p>


<p>回到上层函数 <code>startCoroutineCancellable()</code>​：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> (R)</span></span> -&gt; T).startCoroutineCancellable(</span><br><span class="line">    receiver: R, completion: Continuation&lt;T&gt;,</span><br><span class="line">    onCancellation: ((cause: Throwable) -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line">) =</span><br><span class="line">    runSafely(completion) &#123;</span><br><span class="line">        createCoroutineUnintercepted(receiver, completion).intercepted().resumeCancellableWith(Result.success(<span class="built_in">Unit</span>), onCancellation)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​<code>intercepted()</code>​ 用来将协程放到其所关联的调度器中运行，这个我们先不管，可以认为这个方法不包含任何逻辑，只是 <code>return this</code>。重点是 <code>resumeCancellableWith()</code>​ ：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Continuation<span class="type">&lt;T&gt;</span>.<span class="title">resumeCancellableWith</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    onCancellation: ((<span class="type">cause</span>: <span class="type">Throwable</span>) -&gt; <span class="type">Unit</span>)? = <span class="literal">null</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: <span class="built_in">Unit</span> = <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">is</span> DispatchedContinuation -&gt; resumeCancellableWith(result, onCancellation)</span><br><span class="line">    <span class="keyword">else</span> -&gt; resumeWith(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个分支逻辑总体差不多，只是前者包含了调度相关的逻辑。实际上代码会进入到 <code>is DispatchedContinuation -&gt;</code> 分支，但简单起见，我们假装程序会进入 <code>else</code>​ 分支，因为调度不是我们的重点，我们重点是搞清楚协程中的状态机是怎么回事。<code>else</code>​ 分支调用的是 <code>Continuation</code>​ 的 <code>resumeWith()</code>​，这个方法在 <code>Continuation</code>​ 接口定义：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Continuation</span>&lt;<span class="type">in T</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The context of the coroutine that corresponds to this continuation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> context: CoroutineContext</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resumes the execution of the corresponding coroutine passing a successful or failed [result] as the</span></span><br><span class="line"><span class="comment">     * return value of the last suspension point.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再进一步探索之前，我们先得了解一下协程中的 <code>Continuation</code> ​是什么东西，不然后面会越来越懵逼。先从维基百科对协程的定义入手：</p>
<blockquote>
<p><strong>协程</strong>（英语：coroutine）是计算机程序的一类组件，推广了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%A4%9A%E4%BB%BB%E5%8A%A1" title="协作式多任务">协作式多任务</a>的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%90%E4%BE%8B%E7%A8%8B" title="子例程">子例程</a>，允许执行被挂起与被恢复</p>
</blockquote>
<p>协作式多任务对应于抢占式多任务，前者是任务主动让出 CPU，后者是 CPU 剥夺任务的执行权。但我感觉用协作式多任务来概括协程，还是不够触及本质，因为线程也可以通过锁来实现协作式的挂起和恢复，比如 <code>wait</code> 和 <code>notify</code>。我觉得本质区别还是在于，协程是用户态是实现的多任务，其挂起和恢复也是在用户态进行的，成本较低。换句话说就是，多个协程可以同时跑在一个线程里，协程的切换可以在线程不发生切换的前提下进行。本质上还是那套分时复用的思想，只不过不是复用 CPU，而是线程。有两种实现方案：</p>
<ol>
<li>模拟操作系统对线程的调度。为每个协程分配一个不同于当前线程栈的专属栈，协程如果想要让出 CPU，就转去执行一个用户态例程，这个例程会在用户态对协程栈指针和寄存器进行保存，同时选中一个被挂起的协程，将当前栈指针和寄存器恢复为该协程之前所保存的。通过在不同的栈之间来回切换，实现了协程的调度和并发。但并不是所有语言都能在运行时在多个栈之间切换的，所有就有了下一种方案。</li>
<li>将包含挂起点的方法（或者叫做异步方法，Kotlin 用 <code>suspend</code> 标识，JS 用 <code>async</code> 标识）转换成一个状态机，方法的上下文作为状态保存在状态机中，方法的执行变成了状态机的运行，方法的调用栈变成了状态机链。以前是方法开始，栈帧建立，方法结束，栈帧销毁，栈顶此时是上一个方法的栈帧；现在成了方法开始，状态机建立，方法挂起，状态机在某个中间状态暂停，方法恢复，状态机从上一状态过渡到下一状态，方法结束，状态机进入终止状态并销毁，状态机链末尾此时是上一个方法的状态机。多个协程无非就是多个状态机链，只要轮换着运行不同链末尾的状态机就能实现协程的调度和并发了。</li>
</ol>
<p>采用第一种方案的叫做有栈协程，采用第二种方案的叫做无栈协程。Kotlin 使用的是第二种方案，这应该和 Kotlin 没法直接访问 JVM 虚拟机栈有关。</p>
<!-- <p class="notice-info">除了实现上的不同，两者在使用上也有差异。有栈协程底层是货真价实的栈，方法不感知自己到底是运行在协程上下文还是线程上下文，栈被切换了，栈上的所有方法自然就被挂起了，所以有栈协程不需要用关键字来标识方法到底会不会被挂起。无栈协程则不同，需要开发者用关键字标识异步方法，编译器或运行时好将这些方法转换成状态机。因此无栈协程中异步方法会向上传染：一个方法被标识为异步，调用它方法也需要标识为异步。那为什么不将所有方法都看做是异步的，这样不就无需显式标识了？理论上我觉得这样也行，但如果将所有方法都看做异步，都转换成状态机去运行，效率应该会很低。或许可以根据调用关系自动推断方法是否异步，但编译期的工作量应该会很大，而且对于 Kotlin 这种需要和 Java 互操作的语言可能不太好实现。有栈的一个好处就是，代码不需要专门为协程做适配，比如一个库底层使用了 IO 函数，如果该函数是在协程上下文中调用的，运行时可以使用非阻塞 IO 实现，如果是在线程上下文被调用，就用阻塞 IO 实现，这些差异化的处理对库作者而言是透明的，不需要准备两套代码；但如果这个库想用于无栈协程，开发者就不得不为协程准备一套代码。
</p> -->

<p>​<code>Continuation</code>​ 正是 Kotlin 用于实现协程的状态机。编译器会为每一个 suspend 方法生成一个相关联的 <code>Continuation</code>​ 类，一般是 <code>BaseContinuationImpl</code> 的子类，这个子类实现了父类的 <code>invokeSuspend()</code> 方法，该方法包含了 suspend 方法体的逻辑，但并不是直接 copy。<code>invokeSuspend()</code> 会将 suspend 方法根据挂起点分割成多段，运行时它会被多次调用，每次调用时会从上一挂起点开始执行，执行到下一个挂起点结束，然后保存当前的上下文，记录当前挂起点，上下文和挂起点共同构成了状态机的状态。该方法通常不会被外部直接调用，而是由  ​<code>Continuation</code>​ 的 <code>resumeWith()</code> 方法调用。<code>resumeWith()</code> 可以认为是  ​<code>Continuation</code>​ 暴露给外部的，用来恢复其运行的 API。当前 ​<code>Continuation</code>​ 运行完后（意味着对应的 suspend 方法执行完毕），会调用上游 ​<code>Continuation</code>​ 的 <code>resumeWith()</code> 方法，上游 ​<code>Continuation</code>​ 重复这个过程，直至最顶层的 ​<code>Continuation</code>​ 运行完毕。最顶层的 ​<code>Continuation</code>​ 运行完毕，就意味着最顶层的 suspend 方法执行完毕，同时也意味着协程结束。</p>
<p class="notice-success">现在听上去可能会有点抽象，可以先往下看，等回过头来理解</p>

<p>我们接着研究 <code>resumeWith()</code> ​方法。<code>resumeWith()</code> 是 <code>Continiuation</code> ​接口的唯一方法，它在子类 <code>BaseContinuationImpl</code> ​中有个 <code>final</code> ​实现：</p>
<h3 id="BaseContinuationImpl"><a href="#BaseContinuationImpl" class="headerlink" title="BaseContinuationImpl"></a>BaseContinuationImpl</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseContinuationImpl</span>(</span><br><span class="line">    <span class="comment">// completion 便是上游 suspend 方法关联的 Continuation 对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">val</span> completion: Continuation&lt;Any?&gt;?</span><br><span class="line">) : Continuation&lt;Any?&gt;, CoroutineStackFrame, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> current = <span class="keyword">this</span></span><br><span class="line">        <span class="keyword">var</span> param = result</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            probeCoroutineResumed(current)</span><br><span class="line">            with(current) &#123;</span><br><span class="line">                <span class="keyword">val</span> completion = completion!! <span class="comment">// fail fast when trying to resume continuation without completion</span></span><br><span class="line">                <span class="keyword">val</span> outcome: Result&lt;Any?&gt; =</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">val</span> outcome = invokeSuspend(param)</span><br><span class="line">                        <span class="keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="keyword">return</span></span><br><span class="line">                        Result.success(outcome)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (exception: Throwable) &#123;</span><br><span class="line">                        Result.failure(exception)</span><br><span class="line">                    &#125;</span><br><span class="line">                releaseIntercepted() <span class="comment">// this state machine instance is terminating</span></span><br><span class="line">                <span class="keyword">if</span> (completion <span class="keyword">is</span> BaseContinuationImpl) &#123;</span><br><span class="line">                    <span class="comment">// unrolling recursion via loop</span></span><br><span class="line">                    current = completion</span><br><span class="line">                    param = outcome</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// top-level completion reached -- invoke and return</span></span><br><span class="line">                    completion.resumeWith(outcome)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此方法的实现由编译器生成</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any?</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个典型的用循环展开尾递归的的例子，目的是避免因过深的调用栈造成栈溢出，同时生成更简洁的调用栈信息。为了便于理解，将其还原成递归：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">    probeCoroutineResumed(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">val</span> completion = completion ?: error(<span class="string">&quot;Completion should not be null&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> outcome: Result&lt;Any?&gt; = <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> outcome = invokeSuspend(result)</span><br><span class="line">        <span class="keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="keyword">return</span></span><br><span class="line">        Result.success(outcome)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">        Result.failure(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    releaseIntercepted()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completion <span class="keyword">is</span> BaseContinuationImpl) &#123;</span><br><span class="line">        <span class="comment">// 递归调用上游 Continuation</span></span><br><span class="line">        completion.resumeWith(outcome)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 调用到最顶层 Continuation</span></span><br><span class="line">        completion.resumeWith(outcome)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面说过，<code>invokeSuspend()</code> 会被 <code>resumeWith()</code> 调用，上述代码展现了具体的调用逻辑：如果 <code>invokeSuspend()</code> 返回的是 <code>COROUTINE_SUSPENDED</code>​，说明当前状态机运行到了一个挂起点，<code>resumeWith()</code> 会直接 <code>return</code> ，这就是实现 suspend 方法挂起语义的地方；否则说明当前 suspend 方法执行完毕，此时 <code>invokeSuspend()</code> 返回的结果，就是 suspend 方法的返回值，<code>resumeWith()</code> 会拿这个值去调用上游 <code>Continuation</code>​ 对象的 <code>resumeWith()</code>​ 从而恢复上游 suspend 方法的执行。</p>
<p class="notice-info">Kotlin 将上游 suspend 方法的 Continuation​ 对象命名为 completion​，可以说是非常贴切了。</p>

<p>现在回过头看 <code>_SuspendLambda</code> 的 <code>invokeSuspend()</code> 方法，为便于理解我将其写成 Kotlin 并简化：</p>
<h3 id="SuspendLambda"><a href="#SuspendLambda" class="headerlink" title="_SuspendLambda"></a>_SuspendLambda</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">_SuspendLambda</span> : <span class="type">SuspendLambda</span>, <span class="type">Function1</span>&lt;<span class="type">Object</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">val</span> label = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Object</span>)</span></span>: Object &#123;</span><br><span class="line">		<span class="keyword">var</span> fun1Result: Object?</span><br><span class="line">        <span class="keyword">when</span> (<span class="keyword">this</span>.label) &#123;</span><br><span class="line">            <span class="number">0</span> -&gt; &#123;</span><br><span class="line">                Result.throwOnFailure(result)</span><br><span class="line">                <span class="keyword">this</span>.label = <span class="number">1</span></span><br><span class="line">                fun1Result = fun1(<span class="keyword">this</span> <span class="keyword">as</span> Continuation)         <span class="comment">// fun1()</span></span><br><span class="line">                <span class="keyword">if</span> (fun1Result == COROUTINE_SUSPENDED) &#123;</span><br><span class="line">                    <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="number">1</span> -&gt; &#123;</span><br><span class="line">                Result.throwOnFailure(result)</span><br><span class="line">                fun1Result = result</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> -&gt;</span><br><span class="line">                <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> finalResult = fun1Result <span class="keyword">as</span> <span class="built_in">Int</span></span><br><span class="line">        println(finalResult)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Unit</span>.INSTANCE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">_SuspendLambda</span><span class="params">(Continuation completion)</span></span> &#123;</span><br><span class="line">		<span class="keyword">super</span>(<span class="number">0</span> <span class="comment">/* 这个值具体是多少不知道，也不重要，我这里是乱写的 */</span>, completion):</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/** Invokes the function with the specified arguments. */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(value: <span class="type">CoroutineScope</span>, completion: <span class="type">Continuation</span>)</span></span>: Object &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.create(value, completion).invokeSuspend(completion)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(Object p1, Object p2)</span></span>: Object &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.invoke((CoroutineScope)p1, (Continuation)p2)</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(value: <span class="type">CoroutineScope</span>, completion: <span class="type">Continuation</span>)</span></span>: Continuation &#123;</span><br><span class="line">         <span class="keyword">return</span> _SuspendLambda(completion)</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>invokeSuspend()</code> 将 suspend lambda 分割成了两段（所谓分割，其实就是 <code>switch case</code>）：一段是调用 <code>fun1()</code>​，另一段是打印结果。接下来我们按时间顺序分析一下，Kotlin 协程是如何完成对 suspned lambda 的调用的。</p>
<p>第一次调用<code>_SuspendLambda</code>​的 <code>resumeWith()</code>​ 方法时，<code>label</code>​ 为 <code>0</code>​，会走到 <code>0 -&gt; </code>​这个分支。这个分支的逻辑如下：</p>
<ul>
<li>将 <code>label</code>​ 置位 1，这样下次就会从 <code>1 -&gt;</code>​这个分支执行。</li>
<li>调用 <code>fun1()</code>​，<code>fun1()</code> ​返回的是 <code>COROUTINE_SUSPENDED</code>​，这是因为遇到了 <code>fun1()</code> 的挂起点，<code>fun1()</code> 的挂起也会引起 suspend lambda 的挂起，所以 <code>invokeSuspend()</code>​ 会从第 13 行返回 <code>COROUTINE_SUSPENDED</code>，<code>resumeWith()</code>​ 拿到这个结果后会 <code>return</code>，suspend lambda 挂起。</li>
</ul>
<p>你可能会有疑问，示例代码中的<code>fun1()</code>​ 没有参数，为什么这里会传参数？前面说过，<code>Continuation</code> 是链式结构，下游 <code>Continuation</code>​ 执行完成后，需要调用上游 <code>Continuation</code> 的​ <code>resumeWith()</code>​ 方法来恢复上游方法的执行，因此下游 <code>Continuation</code> 必须持有上游 <code>Continuation</code>​ 的引用才行。因此，和 suspend lambda 一样，Kotlin 编译器也会为每一个 suspend 方法自动添加一个 <code>Continuation</code>​ 类型的参数，从而让下游 <code>Continuation</code> 持有上游的 <code>Continuation</code>​。</p>
<p class="notice-success">后面我们会发现，实际上这个参数有多重含义。上游方法调用下游方法时，传给下游方法的这个参数代表上游方法的 Continuation，下游方法恢复上游方法时，传给上游方法的这个参数是上游方法自身的 Continuation</p>

<p>现在来看 <code>fun1()</code>​，其反编译结果如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> static <span class="keyword">final</span> Object fun1(<span class="meta">@NotNull</span> Continuation var0) &#123;</span><br><span class="line">   Object $continuation;</span><br><span class="line">   label27: &#123;</span><br><span class="line">      <span class="keyword">if</span> (var0 instanceof &lt;undefinedtype&gt;) &#123;</span><br><span class="line">         $continuation = (&lt;undefinedtype&gt;)var0;</span><br><span class="line">         <span class="keyword">if</span> ((((&lt;undefinedtype&gt;)$continuation).label &amp; Integer.MIN_VALUE) != <span class="number">0</span>) &#123;</span><br><span class="line">            ((&lt;undefinedtype&gt;)$continuation).label -= Integer.MIN_VALUE;</span><br><span class="line">            <span class="keyword">break</span> label27;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $continuation = new ContinuationImpl(var0) &#123;</span><br><span class="line">         int I$<span class="number">0</span>;</span><br><span class="line">         <span class="comment">// $FF: synthetic field</span></span><br><span class="line">         Object result;</span><br><span class="line">         int label;</span><br><span class="line"></span><br><span class="line">         <span class="meta">@Nullable</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">final</span> Object invokeSuspend(<span class="meta">@NotNull</span> Object $result) &#123;</span><br><span class="line">            <span class="keyword">this</span>.result = $result;</span><br><span class="line">            <span class="keyword">this</span>.label |= Integer.MIN_VALUE;</span><br><span class="line">            <span class="keyword">return</span> TestKt.fun1((Continuation)<span class="keyword">this</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Object var10000;</span><br><span class="line">   int localInt;</span><br><span class="line">   int var2;</span><br><span class="line">   Object var3;</span><br><span class="line">   label22: &#123;</span><br><span class="line">      Object $result = ((&lt;undefinedtype&gt;)$continuation).result;</span><br><span class="line">      Object var6 = IntrinsicsKt.getCOROUTINE_SUSPENDED();</span><br><span class="line">      switch (((&lt;undefinedtype&gt;)$continuation).label) &#123;</span><br><span class="line">         case <span class="number">0</span>:</span><br><span class="line">            ResultKt.throwOnFailure($result);</span><br><span class="line">            localInt = <span class="number">0</span>;</span><br><span class="line">            var2 = localInt;</span><br><span class="line">            ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span> = localInt;</span><br><span class="line">            ((&lt;undefinedtype&gt;)$continuation).label = <span class="number">1</span>;</span><br><span class="line">            var10000 = fun2((Continuation)$continuation);</span><br><span class="line">            <span class="keyword">if</span> (var10000 == var6) &#123;</span><br><span class="line">               <span class="keyword">return</span> var6;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         case <span class="number">1</span>:</span><br><span class="line">            var2 = ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span>;</span><br><span class="line">            ResultKt.throwOnFailure($result);</span><br><span class="line">            var10000 = $result;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         case <span class="number">2</span>:</span><br><span class="line">            var2 = ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span>;</span><br><span class="line">            ResultKt.throwOnFailure($result);</span><br><span class="line">            var10000 = $result;</span><br><span class="line">            <span class="keyword">break</span> label22;</span><br><span class="line">         default:</span><br><span class="line">            <span class="keyword">throw</span> new IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      var3 = var10000;</span><br><span class="line">      localInt = var2 + ((Number)var3).intValue();</span><br><span class="line">      var2 = localInt;</span><br><span class="line">      ((&lt;undefinedtype&gt;)$continuation).I$<span class="number">0</span> = localInt;</span><br><span class="line">      ((&lt;undefinedtype&gt;)$continuation).label = <span class="number">2</span>;</span><br><span class="line">      var10000 = fun3((Continuation)$continuation);</span><br><span class="line">      <span class="keyword">if</span> (var10000 == var6) &#123;</span><br><span class="line">         <span class="keyword">return</span> var6;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   var3 = var10000;</span><br><span class="line">   localInt = var2 + ((Number)var3).intValue();</span><br><span class="line">   <span class="keyword">return</span> Boxing.boxInt(localInt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了便于理解同样改写成 Kotlin 代码。代码太多，我使用了 ChatGPT 来辅助完成：</p>
<h3 id="fun1"><a href="#fun1" class="headerlink" title="fun1"></a>fun1</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Fun1Continuation</span>(</span><br><span class="line">    <span class="keyword">val</span> completion: Continuation&lt;Any?&gt;</span><br><span class="line">) : ContinuationImpl&lt;Any?&gt;(completion) &#123;</span><br><span class="line">    <span class="keyword">var</span> label = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> result: Any? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> I$<span class="number">0</span>: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.result = result.getOrNull()</span><br><span class="line">        <span class="keyword">this</span>.label = <span class="keyword">this</span>.label or <span class="number">0x80000000</span></span><br><span class="line">        <span class="keyword">return</span> fun1(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fun1</span><span class="params">(continuation: <span class="type">Continuation</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any? &#123;</span><br><span class="line">    <span class="comment">// 如果 continuation 是之前包装过的，直接使用；否则将 continuation 包装成一个 Fun1Continuation，将其作为上游 Continuation 被 Fun1Continuation 持有</span></span><br><span class="line">    <span class="keyword">val</span> cont = <span class="keyword">if</span> (continuation <span class="keyword">is</span> Fun1Continuation) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((continuation.label and <span class="number">0x80000000</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            continuation.label = continuation.label and <span class="number">0x7fffffff</span></span><br><span class="line">            continuation</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Fun1Continuation(continuation)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Fun1Continuation(continuation)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = cont.result</span><br><span class="line"></span><br><span class="line">    run <span class="symbol">handleAfterFun3@</span>&#123;</span><br><span class="line">        run <span class="symbol">handleAfterFun2@</span>&#123;</span><br><span class="line">            <span class="keyword">when</span> (cont.label) &#123;</span><br><span class="line">                <span class="number">0</span> -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 初始状态</span></span><br><span class="line">                    Result.throwOnFailure(result)</span><br><span class="line">                    <span class="keyword">val</span> localInt = <span class="number">0</span></span><br><span class="line">                    cont.I$<span class="number">0</span> = localInt</span><br><span class="line">                    cont.label = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">val</span> res = fun2(cont)</span><br><span class="line">                    <span class="keyword">if</span> (res === COROUTINE_SUSPENDED) <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">                    result = res</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="number">1</span> -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 如果 fun2 是异步，那么从 fun2 恢复时会进入到这个分支</span></span><br><span class="line">                    Result.throwOnFailure(result)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@handleAfterFun2</span> </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="number">2</span> -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 如果 fun3 是异步，那么从 fun3 恢复时会进入到这个分支</span></span><br><span class="line">                    Result.throwOnFailure(result)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@handleAfterFun3</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// fun2 执行完毕后的逻辑，无论同步异步都会走到这</span></span><br><span class="line">        <span class="keyword">val</span> localInt = cont.I$<span class="number">0</span></span><br><span class="line">        cont.I$<span class="number">0</span> = localInt + result</span><br><span class="line">        cont.label = <span class="number">2</span></span><br><span class="line">        <span class="keyword">val</span> res = fun3(cont)</span><br><span class="line">        <span class="keyword">if</span> (res === COROUTINE_SUSPENDED) <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">        result = res</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fun3 执行完毕后的逻辑，无论同步异步都会走到这</span></span><br><span class="line">    <span class="keyword">val</span> localInt = cont.I$<span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> finalResult = localInt + result</span><br><span class="line">    <span class="keyword">return</span> finalResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改写后的代码逻辑清晰多了，我们来分析一下 <code>fun1()</code> 的逻辑：</p>
<ul>
<li><p>首先是为 <code>fun1()</code>​ 构造与之关联的 <code>Continuation</code>​。如果传入的 <code>Continuation</code>​ 是 <code>Fun1Continuation</code>​ 类型，说明已经包装过了，就不做处理，否则，使用 <code>Fun1Continuation</code>​ 对 <code>continuation</code>​ 进行包装，将其作为上游 <code>Continuation</code> 被 <code>Fun1Continuation</code> 持有。最后得到的 <code>cont</code>​ 便是 <code>fun1()</code>​ 所关联的 <code>Continuation</code>​。前面说过，<code>Continuation</code>​ 包含了函数的上下文，从 <code>Fun1Continuation</code> 的定义能看出，这个上下文包含以下几个部分：</p>
<ul>
<li>执行进度，即 <code>cont.label</code>​；​</li>
<li>局部变量，即 <code>cont.I$0</code>​，对应示例中的 <code>localInt</code>​；</li>
<li>上游 <code>suspend</code>​ 方法的 <code>Continuation</code>​ 对象，即 <code>Fun1Continuation</code> 构造方法传入的 <code>completion</code></li>
<li>上次挂起点返回的结果，即 <code>cont.result</code>​；</li>
</ul>
</li>
</ul>
<p>接着往下看，有三个分支。</p>
<p>首先是  <code>0-&gt;</code>​ 分支，<code>fun1()</code>​ 首次调用时会进入这个分支。该分支做了以下几件事：</p>
<ul>
<li>将 <code>label</code>​ 置为 1，将 <code>fun1()</code>​ 执行进度往下推进，下次调用时就会从 <code>1-&gt;</code>​ 这个分支执行。</li>
<li>调用 <code>fun2()</code>​ 获取其结果，如果结果为 <code>COROUTINE_SUSPENDED</code>​ ，说明 <code>fun2()</code>​ 挂起，<code>fun1()</code>​ 也返回 <code>COROUTINE_SUSPENDED</code>，​表示自己因为 <code>fun2()</code>​ 的挂起而挂起。然而实际上<code>fun2()</code>​ 是一个披着 suspend 外衣的普通方法，Kotlin 并不会将它当做 suspend 方法看待，这个方法编译后是一个普通的同步方法，所以此处 <code>fun2()</code>​ 返回的是 1，<code>fun1()</code>​ 会跳转到 61 行继续执行。</li>
<li>将 <code>fun2()</code>​ 返回值累加到 <code>localInt</code>​ 上；</li>
<li>将 <code>label</code>​ 置为 <code>2</code>​，将 <code>fun1()</code>​ 执行往下推进。下次执行时就会从 <code>2-&gt;</code>​ 这个分支执行。由此可见，<code>1-&gt;</code>​ 分支实际上并不会被执行，这是 <code>fun2()</code>​ 为同步方法造成的；</li>
<li>调用 <code>fun3()</code>​ ，<code>fun3()</code>​ 是一个 suspend 方法，它会返回 <code>COROUTINE_SUSPENDED</code>​，故 <code>fun1()</code>​ 会从第  65 行返回，<code>fun1()</code>​ 的执行告一段落。</li>
</ul>
<p>​<code>fun1()</code>​ 此次调用结束后返回 <code>_SuspendLambda</code> 的第 11 行处：<code>fun1Result = fun1(this as Continuation)</code>​，这和前面对上了。</p>
<p>接下来我们分析 <code>fun3()</code>​，<code>fun3()</code>​ 的反编译代码我就不放了，我们直接看用 Kotlin 改写后的简化版：</p>
<h3 id="fun3"><a href="#fun3" class="headerlink" title="fun3"></a>fun3</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Fun3Continuation</span>(</span><br><span class="line">    <span class="keyword">val</span> completion: Continuation&lt;Any?&gt;</span><br><span class="line">) : ContinuationImpl&lt;Any?&gt;(completion) &#123;</span><br><span class="line">    <span class="keyword">var</span> label = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> result: Any? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> context = completion.context</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">Any</span>?&gt;)</span></span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.result = result.getOrNull()</span><br><span class="line">		<span class="keyword">this</span>.label = <span class="keyword">this</span>.label or <span class="number">0x80000000</span></span><br><span class="line">		<span class="keyword">return</span> fun3(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fun3</span><span class="params">(continuation: <span class="type">Continuation</span>&lt;<span class="type">Any</span>?&gt;)</span></span>: Any? &#123;</span><br><span class="line">    <span class="keyword">val</span> cont = <span class="keyword">if</span> (continuation <span class="keyword">is</span> Fun3Continuation) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((continuation.label and <span class="number">0x80000000</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            continuation.label = continuation.label and <span class="number">0x7fffffff</span></span><br><span class="line">            continuation</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Fun3Continuation(continuation)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Fun3Continuation(continuation)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = cont.result</span><br><span class="line"></span><br><span class="line">	<span class="keyword">when</span> (cont.label) &#123;</span><br><span class="line">        <span class="number">0</span> -&gt; &#123;</span><br><span class="line">            Result.throwOnFailure(result)</span><br><span class="line">            cont.label = <span class="number">1</span></span><br><span class="line">            <span class="keyword">val</span> res = delay(<span class="number">1000L</span>, cont)</span><br><span class="line">            <span class="keyword">if</span> (res === COROUTINE_SUSPENDED) <span class="keyword">return</span> COROUTINE_SUSPENDED</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="number">1</span> -&gt; &#123;</span><br><span class="line">            Result.throwOnFailure(result)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalStateException(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑和 <code>fun1()</code>​ 是大同小异的，前面的就不赘述了，进入到 <code>0-&gt; </code>​分支后，调用了 <code>delay()</code>​ 方法，这是 Kotlin 提供的延时函数，它也是一个 suspend 方法，因此它会返回 <code>COROUTINE_SUSPENDED</code>​ 给 <code>fun1()</code>​，这和前面的分析是一致的。</p>
<p>继续深入下去会发现，<code>delay()</code>​ 会将一个延时任务插入到事件循环中，<code>1000ms</code>​ 过后延时任务会调用 <code>Fun3Continuation</code>​ 的 <code>resumeWith()</code>​ 方法，该方法会调到第 9 行的 <code>invokeSuspend()</code>​ 方法，<code>fun3()</code>​ 会再次执行。再次执行时，<code>cont.label </code>​ 为 <code>1</code>​，进入 <code>1-&gt;</code>​ 分支，检查无异常后代码走到 45 行返回 <code>1</code>​，<code>fun3()</code>​ 执行完毕。</p>
<p>​<code>fun3</code>​ 执行完成后，<code>Fun3Continuation</code>​会用 <code>fun3</code>​ 的返回结果 <code>1</code>​ 作为参数调用其 <code>completion</code>​ 也就是 <code>Fun1Continuation</code>​ 的 <code>resumeWith()</code>​ 方法，该方法会调到第 8 行的 <code>invokeSuspend()</code>​ 方法，导致 <code>fun1()</code>​ 再次执行，再次执行时 <code>cont.label</code>​ 为 <code>2</code>​，走到 <code>2-&gt;</code>​ 分支，检查无异常后代码走到第 69 行，将 <code>fun3()</code>​ 的返回结果 <code>1</code>​ 累加到 <code>localInt</code>​ 后将其作为最终结果返回，<code>fun1()</code>​ 执行完毕。</p>
<p>​<code>fun1()</code>​ 执行完成后，<code>Fun1Continuation</code>​会用 <code>fun1</code>​ 的返回结果 <code>localInt</code>​ 作为参数调用其 <code>completion</code>​也就是 <code>_SuspendLambda</code>​ 的 <code>resumeWith()</code>​ 方法，该方法会调到第 5 行的 <code>invokeSuspend()</code>​ 方法，导致 suspend lambda 再次执行，再次执行时  <code>label</code>​ 为 <code>1</code>​， 走到 <code>1 -&gt;</code>​分支处，检查无异常后代码走到第 26 行，将 <code>fun1()</code>​ 的返回结果 <code>localInt</code>​ 打印出来，suspend lambda 执行完毕。</p>
<h2 id="BlockingCoroutine"><a href="#BlockingCoroutine" class="headerlink" title="BlockingCoroutine"></a>BlockingCoroutine</h2><p>我们知道，一个 suspend 方法结束后，其上游 <code>Continuation</code>​ 的 <code>resumeWith()</code>​ 会被调用。那么问题来了，当顶层的 suspend lambda 结束后呢？答案是 <code>BlockingCoroutine</code>​ 的 <code>resumeWith()</code>​ 会被调用。是的，协程本身也是一个 <code>Continuation</code>，它作为 suspend lambda 的上游  <code>Continuation</code>​​ 在 <code>_SuspendLambda#create()</code> ​时传进去。</p>
<p><code>BlockingCoroutine</code>​ 继承自 <code>AbstractCoroutine</code>​，我们先看 <code>AbstractCoroutine</code>​ 的定义。</p>
<h3 id="AbstractCoroutine"><a href="#AbstractCoroutine" class="headerlink" title="AbstractCoroutine"></a>AbstractCoroutine</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractCoroutine</span>&lt;<span class="type">in T</span>&gt;(</span><br><span class="line">    parentContext: CoroutineContext,</span><br><span class="line">    initParentJob: <span class="built_in">Boolean</span>,</span><br><span class="line">    active: <span class="built_in">Boolean</span></span><br><span class="line">) : JobSupport(active), Job, Continuation&lt;T&gt;, CoroutineScope &#123;</span><br><span class="line"></span><br><span class="line">   ……</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCompleted</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCancelled</span><span class="params">(cause: <span class="type">Throwable</span>, handled: <span class="type">Boolean</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">   ……</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Completes execution of this with coroutine with the specified result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> state = makeCompletingOnce(result.toState())</span><br><span class="line">        <span class="keyword">if</span> (state === COMPLETING_WAITING_CHILDREN) <span class="keyword">return</span></span><br><span class="line">        afterResume(state)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">open</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterResume</span><span class="params">(state: <span class="type">Any</span>?)</span></span>: <span class="built_in">Unit</span> = afterCompletion(state)</span><br><span class="line"></span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>AbstractCoroutine#resumeWith</code> ​最终会调到 <code>JobSupport#afterCompletion()</code>​，它在 <code>BlockingCoroutine</code>​有实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">BlockingCoroutine</span>&lt;<span class="type">T</span>&gt;(</span><br><span class="line">    parentContext: CoroutineContext,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> blockedThread: Thread,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> eventLoop: EventLoop?</span><br><span class="line">) : AbstractCoroutine&lt;T&gt;(parentContext, <span class="literal">true</span>, <span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> isScopedCoroutine: <span class="built_in">Boolean</span> <span class="keyword">get</span>() = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">afterCompletion</span><span class="params">(state: <span class="type">Any</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// wake up blocked thread</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != blockedThread)</span><br><span class="line">            unpark(blockedThread)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Suppress(<span class="string">&quot;UNCHECKED_CAST&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">joinBlocking</span><span class="params">()</span></span>: T &#123;</span><br><span class="line">        registerTimeLoopThread()</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            eventLoop?.incrementUseCount()</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="meta">@Suppress(<span class="string">&quot;DEPRECATION&quot;</span>)</span></span><br><span class="line">                    <span class="keyword">if</span> (Thread.interrupted()) <span class="keyword">throw</span> InterruptedException().also &#123; cancelCoroutine(it) &#125;</span><br><span class="line">                    <span class="keyword">val</span> parkNanos = eventLoop?.processNextEvent() ?: <span class="built_in">Long</span>.MAX_VALUE</span><br><span class="line">                    <span class="comment">// note: process next even may loose unpark flag, so check if completed before parking</span></span><br><span class="line">                    <span class="keyword">if</span> (isCompleted) <span class="keyword">break</span></span><br><span class="line">                    parkNanos(<span class="keyword">this</span>, parkNanos)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123; <span class="comment">// paranoia</span></span><br><span class="line">                eventLoop?.decrementUseCount()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123; <span class="comment">// paranoia</span></span><br><span class="line">            unregisterTimeLoopThread()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// now return result</span></span><br><span class="line">        <span class="keyword">val</span> state = <span class="keyword">this</span>.state.unboxState()</span><br><span class="line">        (state <span class="keyword">as</span>? CompletedExceptionally)?.let &#123; <span class="keyword">throw</span> it.cause &#125;</span><br><span class="line">        <span class="keyword">return</span> state <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​<code>afterCompletion()</code> ​会判断当初调用 <code>runBlocking()</code>​ 的线程 <code>blockedThread</code> 和当前线程是不是同一个，如果不是，则将 <code>blockedThread</code> 唤醒，这通常发生在调用 <code>runBlocking()</code>​ 的线程和协程调度器所在线程不相同的情况下，例如我们调用 <code>runBlocking()</code>​ 的时候，指定了 <code>Dispatcher</code>​:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runBlocking(Dispatchers.IO) &#123;</span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>指定 Dispatcher 会导致 24 行的 <code>eventLoop</code>​ 为 <code>null</code>​，从而让 <code>blockedThread</code> 走到 27 行进行无限时长的休眠，以达到阻塞的目的。这种情况下就需要协程在 Dispatcher 线程中结束后，帮助唤醒 <code>blockedThread</code>，从而让 <code>blockedThread</code> 继续执行 <code>runBlocking()</code> 后面的代码。</p>
<p>如果没有指定 <code>Dispatcher</code>​，<code>eventLoop</code> 则不为 <code>null</code>，<code>eventLoop</code> 会充当 Dispatcher。<code>eventLoop</code> 只负责将事件入队，内部没有线程去处理事件，因此需要 <code>blockedThread</code> 在 while 循环中不停地从 <code>eventLoop</code> 中取事件运行，以此驱动协程的运行。等协程结束后，<code>blockedThread</code> 会从 26 行跳出循环，接着执行 <code>runBlocking()</code> 后面的代码。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>每一个 <code>suspend</code>​ 方法都和一个 <code>Continuation</code>​ 对象关联着；（<code>fun2()</code>​ 这种并没有真正 <code>suspend</code>​ 的方法除外）</li>
<li>Kotlin 协程中的所谓状态机，其实就是 <code>suspend</code>​ 方法关联的 <code>Continuation</code>​ 对象，<code>Continuation</code>​ 的状态即 suspend 方法的上下文，方法从何处恢复，由 <code>Continuation</code>​ 的 <code>label</code> 字段决定。</li>
<li>​<code>Contiuation</code>​ 在无栈协程中充当了栈帧（上下文）：<ul>
<li>保存了局部变量，即 <code>Continuation</code>​ 中的 <code>I$0</code>​ 字段；</li>
<li>保存了方法中断后的返回地址，即 <code>label</code>​；</li>
<li>每一个 <code>Continuation</code>​ 通过 <code>completion</code>​ 字段引用上游方法的 <code>Continuation</code>​，构成了一条<code>Continuation</code>​ 链，这就是 suspend 方法的 “调用栈”。</li>
</ul>
</li>
</ul>
<p>最后画一张图帮助理解：</p>
<p><img src="/img/in-post/post_kotlin_coroutine_state_machine/kotlin_coroutine.svg" alt="Kotlin 协程"></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Chance
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://liwenkun.github.io/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/" title="探究 Kotlin 协程中的状态机">https://liwenkun.github.io/2024/04/08/2024-04-08-kotlin-coroutine-state-machine/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Kotlin/" rel="tag"><i class="fa fa-tag"></i> Kotlin</a>
              <a href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 协程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/04/04/2024-04-04-understand-cross-origin/" rel="prev" title="理解跨源资源共享（CORS）">
      <i class="fa fa-chevron-left"></i> 理解跨源资源共享（CORS）
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/12/07/2025-12-07-Rust-ownership-understanding/" rel="next" title="对 Rust 所有权的理解">
      对 Rust 所有权的理解 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <script src="https://utteranc.es/client.js"                                     repo="liwenkun/liwenkun.github.io"                                     issue-term="pathname"                                     theme="github-dark"                                     crossorigin="anonymous"                                     async>                                 </script>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.</span> <span class="nav-text">一个简单的示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Builders-runBlocking"><span class="nav-number">2.1.</span> <span class="nav-text">Builders#runBlocking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Coroutine-Start"><span class="nav-number">2.2.</span> <span class="nav-text">Coroutine#Start</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CoroutineStarter-invoke"><span class="nav-number">2.2.1.</span> <span class="nav-text">CoroutineStarter#invoke</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cancellable-startCoroutineCancellable"><span class="nav-number">2.2.2.</span> <span class="nav-text">Cancellable#startCoroutineCancellable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IntrinsicsJvm-createCoroutineUnintercepted"><span class="nav-number">2.2.3.</span> <span class="nav-text">IntrinsicsJvm#createCoroutineUnintercepted</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#main"><span class="nav-number">2.3.</span> <span class="nav-text">main</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BaseContinuationImpl"><span class="nav-number">2.3.1.</span> <span class="nav-text">BaseContinuationImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SuspendLambda"><span class="nav-number">2.3.2.</span> <span class="nav-text">_SuspendLambda</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fun1"><span class="nav-number">2.3.3.</span> <span class="nav-text">fun1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fun3"><span class="nav-number">2.3.4.</span> <span class="nav-text">fun3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BlockingCoroutine"><span class="nav-number">2.4.</span> <span class="nav-text">BlockingCoroutine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractCoroutine"><span class="nav-number">2.4.1.</span> <span class="nav-text">AbstractCoroutine</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chance"
      src="https://www.gravatar.com/avatar/95a0f14d3e6b40995a92c41673fd09d4?s=640">
  <p class="site-author-name" itemprop="name">Chance</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/liwenkun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liwenkun" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chance@liwenkun.me" title="E-Mail → mailto:chance@liwenkun.me" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://ylqhust.github.io/" title="http:&#x2F;&#x2F;ylqhust.github.io" rel="noopener" target="_blank">ylqhust的博客</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chance</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">280k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:15</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
